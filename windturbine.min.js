/*
 The MIT License (MIT)
 https://raw.githubusercontent.com/johnwhitetb/windturbine/master/LICENSE
 @copyright John White 2015
*/
var WindTurbine=function(){var l={stackable:!0,cache:!0,queue:!1,method:"GET",expire:1E4},k=this;this.setup=function(a){g.copySettings(a,l)};this.ajax=function(a){var b;a=g.initSettings(a||{});if(0<a.delay)return b=setTimeout(function(){a.delay=0;k.ajax(a)},a.delay);h.controller.init(a,function(b){"success"==b.label?g.invokeUserCallback(a.success,[b.response,b.xhr]):g.invokeUserCallback(a.error,[b.label,b.error,b.xhr]);g.invokeUserCallback(a.complete,[b.label,b.xhr])});return!0};this.preload=function(a,
b,c,d){var e={};g.copySettings(d,e);e.url=a;e.life=b||1;e.expire=c;e.preloadOnly=!0;return k.ajax(e)};this.get=function(a,b,c,d){var e={};g.copySettings(d,e);e.url=a;e.method="GET";c||!b||d&&"dataType"in d?(e.success=b||null,e.error=c||null):(e.error=function(a,b,c){e.success(b.message,c,a)},e.success=function(a,c){b(a,c,"success")});k.ajax(e)};this.post=function(a,b,c,d,e){var f={};g.copySettings(e,f);f.url=a;f.method="POST";f.data=b;f.success=c||null;f.error=d||null;f.error||!f.success||"dataType"in
f||(f.error=function(a,b,c){f.success(b.message,c)});k.ajax(f)};this.json=function(a,b,c){var d={};"function"==typeof b&&(c=b,b=null);b?(d.method="POST",d.data=b):(d.method="GET",d.cache=!1,d.stackable=!1);d.url=a;d.dataType="json";d.success=function(a,b){c&&c(a,b)};d.error=function(a,b,d){console.error(b,d);c&&c(null,d)};k.ajax(d)};var h={controller:{init:function(a,b){var c=this;a.queue?this.state?this.queue.push({settings:a,callback:b}):(this.state=1,this.send(a,function(a){b(a);c.queue.length?
(a=c.queue.shift(),c.init(a.settings,a.callback)):c.state=0})):this.send(a,b)},send:function(a,b){var c=h.stack.createKey(a);c?h.stack.addRequest(a,c,b):h.request.send(h.request.create(a.factory),a,b)},state:0,queue:[]},stack:{loading:{},loaded:{},addRequest:function(a,b,c){var d,e=this;if(a.preloadOnly&&(this.getCached(b,!0)||this.loading.hasOwnProperty(b)))c({label:"abort",xhr:this.loading[b]||this.loaded[b].xhr});else if(!1!==(d=this.getCached(b)))try{c({label:"success",response:h.request.getResponse(d,
a.dataType),xhr:d})}catch(f){c({label:"parseerror",error:f,xhr:d})}else this.loading.hasOwnProperty(b)&&this.loading[b].bActive?(d=this.loading[b].xhr,"onprogress"in d&&"progress"in a&&g.addEvent(d,"progress",function(b){g.invokeUserCallback(a.progress,[b])}),h.request.onReady(d,a,function(d){a.preloadOnly||h.stack.getCached(b);c(d)})):(d=h.request.create(a.factory),this.loading[b]={xhr:d,bActive:!0},h.request.send(d,a,function(f){e.loading[b].bActive=!1;"success"==f.label&&a.life&&(e.loaded[b]={xhr:h.request.derive(d),
timestamp:Date.now(),life:a.life,expire:a.expire});setTimeout(function(){delete e.loading[b]},0);c(f)}),"onprogress"in d&&"progress"in a&&g.addEvent(d,"progress",function(b){g.invokeUserCallback(a.progress,[b])}))},createKey:function(a){if(!("XMLHttpRequestEventTarget"in window&&"JSON"in window&&a.stackable)||"GET"!=a.method&&"HEAD"!=a.method)return!1;try{return JSON.stringify([a.url,a.data,a.headers,a.username,a.password,a.method])}catch(b){return!1}},getCached:function(a,b){var c=this;if(a&&this.loaded.hasOwnProperty(a)&&
0<this.loaded[a].life){if(this.loaded[a].timestamp>Date.now()-this.loaded[a].expire){if(b)return!0;0===--this.loaded[a].life&&setTimeout(function(){delete c.loaded[a]},0);return this.loaded[a].xhr}setTimeout(function(){delete c.loaded[a]},0)}return!1}},request:{create:function(a){return new (window.XMLHttpRequest||window.ActiveXObject)("MSXML2.XMLHTTP.3.0")},derive:function(a){for(var b=a.getAllResponseHeaders(),c=b.split("\n"),d={},e,f=0;f<c.length;++f)e=c[f].split(": "),d[e[0]]=e[1];return{derived:!0,
response:a.response,responseBody:a.responseBody,responseText:a.responseText,responseType:a.responseType,responseXML:a.responseXML,status:a.status,statusText:a.statusText,getAllResponseHeaders:function(){return b},getResponseHeader:function(a){return d[a]}}},send:function(a,b,c){var d=b.url;b.cache&&(d=-1===b.url.indexOf("?")?d+("?_="+Date.now()):d+("&_="+Date.now()));a.open(b.method,d,!0,b.username,b.password);(b.username||b.password)&&a.setRequestHeader("Authorization","Basic "+btoa(b.username+":"+
b.password));for(var e in b.headers)b.headers.hasOwnProperty(e)&&a.setRequestHeader(e,b.headers[e]);0<b.timeout&&"onload"in a&&("timeout"in a?a.timeout=b.timeout:setTimeout(function(){a&&4!==a.readyState&&a.abort()},b.timeout));h.request.onReady(a,b,c);b.data?b.process?(b.headers&&b.headers["Content-Type"]||a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.send(this.queryString(b.data))):a.send(b.data):a.send()},onReady:function(a,b,c){var d={0:200,1223:204};"onload"in a?(g.addEvent(a,
"load",function(){try{c({label:"success",response:h.request.getResponse(a,b.dataType),xhr:a})}catch(d){c({label:"parseerror",error:d,xhr:a})}}),g.addEvent(a,"error",function(){c({label:"error",error:Error(a.statusText),xhr:a})}),g.addEvent(a,"abort",function(){c({label:"abort",error:Error("Aborted"),xhr:a})}),"timeout"in a&&g.addEvent(a,"timeout",function(){c({label:"timeout",error:Error("Timed Out"),xhr:a})})):g.addEvent(a,"readystatechange",function(){if(4===a.readyState)if(200!==(d[a.status]||
a.status)||"response"in a&&"data"!==a.response.type)c({label:"error",error:Error(a.statusText),xhr:a});else try{c({label:"success",response:h.request.getResponse(a,b.dataType),xhr:a})}catch(e){c({label:"parseerror",error:e,xhr:a})}})},getResponse:function(a,b){var c={"application/json":"json","application/x-resource+json":"json","application/x-collection+json":"json","application/vnd.api+json":"json","text/xml":"xml","application/xml":"xml"};b||(b=c[a.getResponseHeader("Content-Type").split(";")[0]]);
switch(b){case "json":return JSON.parse(a.responseText);case "xml":return a.responseXML;default:return a.responseText}},queryString:function(a){var b="",c=0;if("String"==a.constructor.name)return a;for(var d in a)if(a.hasOwnProperty(d))switch(typeof a[d]){case "string":case "number":case "boolean":case "object":case "symbol":0<c++&&(b+="&");b+=d+"=";if("object"==typeof a[d])try{b+=encodeURIComponent(JSON.stringify(a[d]))}catch(e){console.error("The following property could not be appended to query string: "+
d),console.error(e)}else b+=encodeURIComponent(a[d]);break;default:console.error("The following property could not be appended to query string: "+d)}return b}}},g={initSettings:function(a){var b,c={};this.copySettings(a,c);if(a.srcElement)for(var d=0;d<a.srcElement.attributes.length;++d)if(b=a.srcElement.attributes[d],/^data-wt-/.test(b.name)){var e=b.name.substr(8).replace(/-(.)/g,function(a,b){return b.toUpperCase()});c[e]=b.value}for(var f in l)l.hasOwnProperty(f)&&!c.hasOwnProperty(f)&&(c[f]=
l[f]);c.preloadOnly&&!c.life&&(c.life=1);c.method&&(c.method=c.method.toUpperCase());c.url=c.url||window.location.href;c.data&&null===c.process&&c.data.constructor=={}.constructor&&(c.process=!0);return c},addEvent:function(a,b,c){try{a.addEventListener(b,c)}catch(d){try{a.attachEvent("on"+b,c)}catch(e){a["on"+b]=c}}},invokeUserCallback:function(a,b){if(!a)return null;try{if(a instanceof String){for(var c=a.split("."),d=c.pop(),e=window,f=0;f<c.length;f++)e=e[c[f]];return e[d].apply(e[d],b)}return a.apply(a,
b)}catch(g){console.error("Error in callback:"),console.error(g)}},copySettings:function(a,b){if(a)for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c])}}};
